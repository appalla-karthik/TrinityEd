  {% extends "base.html" %}
{% load static %}

{% block title %}Mentor Dashboard | TrinityEd{% endblock %}

{% block content %}
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    /* üî• Animated Background */
    body {
      background: linear-gradient(135deg, #f0f4ff, #e6f0ff, #fefefe);
      background-size: 300% 300%;
      animation: gradientShift 12s ease infinite;
      font-family: 'Inter', system-ui, sans-serif;
      scroll-behavior: smooth;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* macOS Window */
    .mac-window {
      width: 90%;
      margin: 2rem auto;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      background: #fff;
      transition: all 0.3s ease;
    }
    .mac-header {
      background: #f1f1f1;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .mac-btn {
      width: 14px; height: 14px;
      border-radius: 50%;
      display: inline-block;
      cursor: pointer;
    }
    .mac-btn.red { background: #ff5f57; }
    .mac-btn.yellow { background: #ffbd2f; }
    .mac-btn.green { background: #28c840; }

    /* Sidebar Anim */
    @keyframes slideInLeft { 
      from { opacity: 0; transform: translateX(-30px); } 
      to { opacity: 1; transform: translateX(0); } 
    }
    aside { animation: slideInLeft 0.7s ease-out; }
    .sidebar-link {
      transition: all 0.3s ease;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }
    .sidebar-link::after {
      content: "";
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(37,99,235,0.1), transparent);
      transition: left 0.4s ease;
    }
    .sidebar-link:hover::after { left: 100%; }
    .sidebar-link:hover {
      color: #2563eb;
      transform: translateX(6px);
      box-shadow: inset 4px 0 0 #2563eb;
    }
    .active-link {
      background: linear-gradient(90deg, #2563eb33, #2563eb11);
      color: #2563eb;
      font-weight: 600;
    }

    /* Stat Cards */
    .stat-card {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 1px solid rgba(37,99,235,0.1);
      transition: transform 0.5s ease, box-shadow 0.5s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .icon-box {
      transition: all 0.3s ease;
      position: relative;
    }
    .stat-card:hover {
      box-shadow: 0 8px 32px rgba(37,99,235,0.25);
    }
    .icon-box:hover {
      transform: rotate(10deg) scale(1.15);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: all 0.5s ease;
    }

    /* Progress Ring */
    .progress-ring__circle {
      stroke-dasharray: 339.292;
      stroke-dashoffset: 339.292;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      stroke-linecap: round;
      filter: drop-shadow(0 0 10px currentColor);
      transition: stroke-dashoffset 1.5s ease, stroke 0.5s ease;
    }
    .gradient-blue { stroke: url(#gradientBlue); }
    .gradient-red { stroke: url(#gradientRed); }
    .gradient-green { stroke: url(#gradientGreen); }

    /* Material Icons Bounce */
    .material-icons {
      animation: bounce 1.5s infinite;
    }
    @keyframes bounce {
      0%,100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    /* Count Up Pulse */
    .count-up {
      animation: pulse 1s ease-in-out forwards;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    /* Alerts */
    .alert-item {
      transition: all 0.3s ease;
      animation: fadeUp 0.6s ease forwards;
      opacity: 0;
      transform-origin: left;
      position: relative;
    }
    .alert-item:hover {
      background: rgba(37,99,235,0.05);
      border-radius: 10px;
    }
    .alert-item::before {
      content: "‚ö†Ô∏è";
      position: absolute;
      left: -28px;
      opacity: 0;
      transform: translateX(-8px);
      transition: all 0.3s ease;
    }
    .alert-item:hover::before {
      opacity: 1;
      transform: translateX(0);
    }
    .alert-badge {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
    }

    /* Charts and Tables */
    .chart-box, .table-box {
      animation: fadeUp 1s ease forwards;
      opacity: 0;
      transform-origin: bottom;
      transition: transform 0.35s ease, box-shadow 0.35s ease;
      position: relative;
      overflow: hidden;
      border-radius: 20px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(37,99,235,0.15);
    }
    .chart-box:hover, .table-box:hover { 
      transform: scale(1.05); 
      box-shadow: 0 14px 32px rgba(37,99,235,0.28);
    }

    /* ‚ú® Shimmer Effect */
    .chart-box::before, .table-box::before {
      content: "";
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: linear-gradient(120deg, rgba(255,255,255,0.35), transparent, rgba(255,255,255,0.35));
      transform: rotate(25deg);
      animation: shimmer 6s linear infinite;
      pointer-events: none;
    }
    @keyframes shimmer {
      0% { transform: translateX(-50%) rotate(25deg); }
      100% { transform: translateX(50%) rotate(25deg); }
    }

    /* Table Styling */
    .risk-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    .risk-table th, .risk-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(37,99,235,0.1);
    }
    .risk-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #2563eb;
    }
    .risk-table tr:hover {
      background: rgba(37,99,235,0.05);
    }
    .risk-level-very-high { color: #dc2626; }
    .risk-level-high { color: #ef4444; }
    .risk-level-medium { color: #f59e0b; }
    .risk-level-low { color: #10b981; }
    .risk-level-very-low { color: #22c55e; }

    /* FadeUp and FadeIn */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(25px) scale(0.96); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(25px) scale(0.95); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.8s forwards;
    }
    .delay-100 { animation-delay: 0.1s; }
    .delay-200 { animation-delay: 0.2s; }
    .delay-300 { animation-delay: 0.3s; }

    /* SVG Gradients for Progress Rings */
    svg defs linearGradient#gradientBlue stop:nth-child(1) { stop-color: #2563eb; }
    svg defs linearGradient#gradientBlue stop:nth-child(2) { stop-color: #3b82f6; }
    svg defs linearGradient#gradientRed stop:nth-child(1) { stop-color: #ef4444; }
    svg defs linearGradient#gradientRed stop:nth-child(2) { stop-color: #f87171; }
    svg defs linearGradient#gradientGreen stop:nth-child(1) { stop-color: #10b981; }
    svg defs linearGradient#gradientGreen stop:nth-child(2) { stop-color: #34d399; }
  </style>
</head> 

<body class="flex flex-col min-h-screen">
  <!-- SVG Definitions for Gradients -->
  <svg style="position: absolute; width: 0; height: 0;">
    <defs>
      <linearGradient id="gradientBlue">
        <stop offset="0%" stop-color="#2563eb"/>
        <stop offset="100%" stop-color="#3b82f6"/>
      </linearGradient>
      <linearGradient id="gradientRed">
        <stop offset="0%" stop-color="#ef4444"/>
        <stop offset="100%" stop-color="#f87171"/>
      </linearGradient>
      <linearGradient id="gradientGreen">
        <stop offset="0%" stop-color="#10b981"/>
        <stop offset="100%" stop-color="#34d399"/>
      </linearGradient>
    </defs>
  </svg>

  <!-- macOS Window Wrapper -->
  <div id="macWindow" class="mac-window flex flex-col h-[90vh]">
    <div class="mac-header">
      <span id="btnClose" class="mac-btn red"></span>
      <span id="btnMinimize" class="mac-btn yellow"></span>
      <span id="btnMaximize" class="mac-btn green"></span>
      <span class="ml-4 font-medium text-gray-600">Mentor Dashboard</span>
    </div>

    <!-- Main Content -->
    <main id="macContent" class="flex-1 p-8 overflow-y-auto animate-fadeIn">
      <div class="flex justify-end mb-4">
        <a href="{% url 'student_list' %}" 
           class="flex items-center gap-2 px-5 py-2 rounded-xl bg-blue-600 text-white font-medium shadow-md hover:bg-blue-700 hover:shadow-lg transition-all duration-300">
          <span class="material-icons text-sm">person_add</span>
          Add Student
        </a>
      </div>

      <!-- Stats Cards Row -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <!-- Total Students Card -->
        <div class="stat-card p-6 rounded-2xl flex items-center gap-5 hover:scale-105 transition-transform duration-500">
          <div class="icon-box relative w-20 h-20 flex items-center justify-center">
            <svg class="progress-ring w-20 h-20 absolute" viewBox="0 0 120 120">
              <circle class="progress-ring__bg" stroke="#ffffff33" stroke-width="10" fill="transparent" r="54" cx="60" cy="60"/>
              <circle class="progress-ring__circle gradient-blue" stroke-width="10" fill="transparent" r="54" cx="60" cy="60"/>
            </svg>
            <span class="material-icons text-3xl text-blue-700">groups</span>
          </div>
          <div>
            <h3 class="text-sm font-medium text-gray-500">Total Students</h3>
            <p class="text-3xl font-extrabold text-blue-700 count-up" data-target="{{ total_students }}">{{ total_students }}</p>
          </div>
        </div>

        <!-- At-Risk Students Card -->
        <div class="stat-card p-6 rounded-2xl flex items-center gap-5 hover:scale-105 transition-transform duration-500">
          <div class="icon-box relative w-20 h-20 flex items-center justify-center">
            <svg class="progress-ring w-20 h-20 absolute" viewBox="0 0 120 120">
              <circle class="progress-ring__bg" stroke="#ffffff33" stroke-width="10" fill="transparent" r="54" cx="60" cy="60"/>
              <circle class="progress-ring__circle gradient-red" stroke-width="10" fill="transparent" r="54" cx="60" cy="60"/>
            </svg>
            <span class="material-icons text-3xl text-red-600">warning</span>
          </div>
          <div>
            <h3 class="text-sm font-medium text-gray-500">At-Risk Students</h3>
            <p class="text-3xl font-extrabold text-red-600 count-up" data-target="{{ at_risk }}">{{ at_risk }}</p>
          </div>
        </div>

        <!-- Alerts Sent Card -->
        <div class="stat-card p-6 rounded-2xl flex items-center gap-5 hover:scale-105 transition-transform duration-500">
          <div class="icon-box relative w-20 h-20 flex items-center justify-center">
            <svg class="progress-ring w-20 h-20 absolute" viewBox="0 0 120 120">
              <circle class="progress-ring__bg" stroke="#ffffff33" stroke-width="10" fill="transparent" r="54" cx="60" cy="60"/>
              <circle class="progress-ring__circle gradient-green" stroke-width="10" fill="transparent" r="54" cx="60" cy="60"/>
            </svg>
            <span class="material-icons text-3xl text-green-600">notifications_active</span>
          </div>
          <div>
            <h3 class="text-sm font-medium text-gray-500">Alerts Sent</h3>
            <p class="text-3xl font-extrabold text-green-600 count-up" data-target="{{ alerts_sent }}">{{ alerts_sent }}</p>
          </div>
        </div>
      </div>

      <!-- Charts and Analytics -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Attendance Chart -->
        <div class="chart-box bg-white/90 backdrop-blur-md p-6 border border-gray-200 shadow-md rounded-2xl delay-100">
          <h3 class="text-lg font-semibold mb-4 text-gray-700">Attendance Trends</h3>
          <canvas id="attendanceChart" role="img" aria-label="Line chart showing attendance trends over time"></canvas>
        </div>
        <!-- Performance Chart -->
        <div class="chart-box bg-white/90 backdrop-blur-md p-6 border border-gray-200 shadow-md rounded-2xl delay-200">
          <h3 class="text-lg font-semibold mb-4 text-gray-700">Performance Overview</h3>
          <canvas id="performanceChart" role="img" aria-label="Bar chart showing average performance scores by subject"></canvas>
        </div>
        <!-- Risk Distribution Chart -->
        <div class="chart-box bg-white/90 backdrop-blur-md p-6 border border-gray-200 shadow-md rounded-2xl delay-300">
          <h3 class="text-lg font-semibold mb-4 text-gray-700">Risk Distribution</h3>
          <canvas id="riskDistributionChart" role="img" aria-label="Pie chart showing distribution of student dropout risk levels"></canvas>
        </div>
      </div>

      <!-- Risk Assessments Table -->
      <div class="table-box bg-white/90 backdrop-blur-md p-6 border border-gray-200 shadow-md rounded-2xl mb-8">
        <h3 class="text-lg font-semibold mb-4 text-gray-700">Risk Assessments</h3>
        <table class="risk-table" role="grid" aria-label="Table of student risk assessments">
          <thead>
            <tr>
              <th scope="col">Student</th>
              <th scope="col">Grade</th>
              <th scope="col">Risk Level</th>
              <th scope="col">Risk Score</th>
              <th scope="col">Primary Factors</th>
            </tr>
          </thead>
          <tbody>
            {% for student in risk_data %}
              <tr class="alert-item">
                <td>{{ student.student_name }}</td>
                <td>{{ student.grade_level }}</td>
                <td class="risk-level-{{ student.risk_level_hyphenated }}">{{ student.risk_level }}</td>
                <td>{{ student.risk_score|floatformat:1 }}</td>
                <td>{{ student.primary_risk_factors }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-gray-500">No risk assessments available.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- AI Insights Section -->
      <div class="table-box bg-white/90 backdrop-blur-md p-6 border border-gray-200 shadow-md rounded-2xl mb-8">
        <h3 class="text-lg font-semibold mb-4 text-gray-700">AI Insights</h3>
        <div class="mb-4">
          <h4 class="text-md font-medium text-gray-600">Executive Summary</h4>
          <p class="text-gray-700">{{ insights.executive_summary|default:"No summary available." }}</p>
        </div>
        <div>
          <h4 class="text-md font-medium text-gray-600">Key Findings</h4>
          <ul class="list-disc pl-5 text-gray-700">
            {% for finding in insights.key_findings %}
              <li class="alert-item">{{ finding }}</li>
            {% empty %}
              <li class="text-gray-500">No key findings available.</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Alerts Section -->
      <div class="table-box bg-white/90 backdrop-blur-md p-6 border border-gray-200 shadow-md rounded-2xl">
        <h3 class="text-lg font-semibold mb-4 text-gray-700">Recent Alerts</h3>
        <ul class="divide-y divide-gray-200">
          {% for alert in alerts %}
            <li class="alert-item py-2 flex justify-between rounded-md px-2">
              <span>{{ alert.student }} - {{ alert.issue }}</span>
              <span class="alert-badge bg-red-100 text-red-600">Critical</span>
            </li>
          {% empty %}
            <li class="alert-item py-2 text-gray-500">No alerts at the moment.</li>
          {% endfor %}
        </ul>
      </div>
    </main>
  </div>

  <!-- JavaScript functionality -->
  <script>
    // macOS Window Controls
    const macWindow = document.getElementById("macWindow");
    const macContent = document.getElementById("macContent");
    const btnClose = document.getElementById("btnClose");
    const btnMinimize = document.getElementById("btnMinimize");
    const btnMaximize = document.getElementById("btnMaximize");

    let isMaximized = false;
    let isMinimized = false;

    btnClose.addEventListener("click", () => {
      macWindow.style.display = "none";
    });

    btnMinimize.addEventListener("click", () => {
      if (!isMinimized) {
        if (isMaximized) {
          macWindow.style.position = "static";
          macWindow.style.width = "90%";
          macWindow.style.height = "90vh";
          macWindow.style.margin = "2rem auto";
          macWindow.style.borderRadius = "14px";
          macContent.style.display = "block";
          isMaximized = false;
          return;
        }
        macContent.style.display = "none";
        macWindow.style.height = "60px";
        macWindow.style.margin = "2rem auto";
      } else {
        macContent.style.display = "block";
        macWindow.style.height = "90vh";
        macWindow.style.margin = "2rem auto";
      }
      isMinimized = !isMinimized;
    });

    btnMaximize.addEventListener("click", () => {
      if (!isMaximized) {
        macWindow.style.position = "fixed";
        macWindow.style.top = "0";
        macWindow.style.left = "0";
        macWindow.style.width = "100%";
        macWindow.style.height = "100vh";
        macWindow.style.margin = "0";
        macWindow.style.borderRadius = "0";
      } else {
        macWindow.style.position = "static";
        macWindow.style.width = "90%";
        macWindow.style.height = "90vh";
        macWindow.style.margin = "2rem auto";
        macWindow.style.borderRadius = "14px";
      }
      macContent.style.display = "block";
      isMaximized = !isMaximized;
      if (isMaximized) isMinimized = false;
    });

    // Count-up Animation
    document.querySelectorAll('.count-up').forEach(el => {
      const target = +el.getAttribute('data-target');
      let count = 0;
      const step = Math.ceil(target / 100);

      const update = () => {
        count += step;
        if (count > target) count = target;
        el.textContent = count;
        if (count < target) requestAnimationFrame(update);
      };
      update();
    });

    // Progress Ring Animation
    document.querySelectorAll('.stat-card').forEach(card => {
      const circle = card.querySelector('.progress-ring__circle');
      const target = +card.querySelector('.count-up').getAttribute('data-target');
      const maxValue = 120;
      const radius = 54;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (target / maxValue) * circumference;

      setTimeout(() => {
        circle.style.strokeDashoffset = offset;
      }, 500);
    });

    // Attendance Chart
    const ctx1 = document.getElementById('attendanceChart').getContext('2d');
    const gradientBlue = ctx1.createLinearGradient(0, 0, 0, 300);
    gradientBlue.addColorStop(0, 'rgba(37,99,235,0.35)');
    gradientBlue.addColorStop(1, 'rgba(37,99,235,0.05)');

    new Chart(ctx1, {
      type: 'line',
      data: {
        labels: {{ attendance_labels|safe }},
        datasets: [{
          label: 'Attendance %',
          data: {{ attendance_data|safe }},
          borderColor: '#2563eb',
          backgroundColor: gradientBlue,
          fill: true,
          tension: 0.35,
          borderWidth: 3,
          pointRadius: 6,
          pointHoverRadius: 9,
          pointHoverBackgroundColor: "#fff",
          pointHoverBorderColor: "#2563eb",
          pointHoverBorderWidth: 3
        }]
      },
      options: {
        plugins: {
          tooltip: {
            enabled: true,
            callbacks: {
              label: function(context) {
                let val = context.raw;
                return val < 70 ? `‚ö† Low Attendance: ${val}%` : `‚úÖ Attendance: ${val}%`;
              }
            }
          }
        },
        interaction: {
          mode: 'nearest',
          intersect: false
        },
        scales: {
          y: { max: 100, beginAtZero: true }
        }
      }
    });

    // Performance Chart
    const ctx2 = document.getElementById('performanceChart').getContext('2d');
    const gradients = [
      ['rgba(37,99,235,0.9)','rgba(37,99,235,0.6)'],
      ['rgba(219,39,119,0.9)','rgba(219,39,119,0.6)'],
      ['rgba(217,119,6,0.9)','rgba(217,119,6,0.6)'],
      ['rgba(5,150,105,0.9)','rgba(5,150,105,0.6)']
    ];
    const bgColors = gradients.map(g => {
      let grad = ctx2.createLinearGradient(0,0,0,400);
      grad.addColorStop(0,g[0]);
      grad.addColorStop(1,g[1]);
      return grad;
    });

    new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: {{ performance_subjects|safe }},
        datasets: [{
          label: 'Average Score',
          data: {{ performance_data|safe }},
          borderRadius: 14,
          backgroundColor: bgColors,
          hoverBackgroundColor: ["#1d4ed8","#be185d","#b45309","#047857"]
        }]
      },
      options: {
        plugins: {
          tooltip: {
            enabled: true,
            callbacks: {
              label: function(context) {
                let val = context.raw;
                if (val < 70) return `‚ùå Below Avg: ${val}`;
                if (val >= 70 && val < 80) return `‚ö† Needs Improvement: ${val}`;
                return `‚≠ê Excellent: ${val}`;
              }
            }
          }
        },
        interaction: {
          mode: 'index',
          intersect: false
        },
        scales: {
          y: { max: 100, beginAtZero: true }
        }
      }
    });

    // Risk Distribution Chart
    const ctx3 = document.getElementById('riskDistributionChart').getContext('2d');
    const riskGradient = ctx3.createLinearGradient(0, 0, 0, 300);
    riskGradient.addColorStop(0, 'rgba(239,68,68,0.9)');
    riskGradient.addColorStop(1, 'rgba(239,68,68,0.3)');

    new Chart(ctx3, {
      type: 'pie',
      data: {
        labels: ['Very High', 'High', 'Medium', 'Low', 'Very Low'],
        datasets: [{
          data: [
            {{ insights.risk_distribution.Very_High|default:0 }},
            {{ insights.risk_distribution.High|default:0 }},
            {{ insights.risk_distribution.Medium|default:0 }},
            {{ insights.risk_distribution.Low|default:0 }},
            {{ insights.risk_distribution.Very_Low|default:0 }}
          ],
          backgroundColor: ['#dc2626', '#ef4444', '#f59e0b', '#10b981', '#22c55e'],
          hoverBackgroundColor: ['#b91c1c', '#dc2626', '#d97706', '#059669', '#16a34a'],
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        plugins: {
          tooltip: {
            enabled: true,
            callbacks: {
              label: function(context) {
                let label = context.label || '';
                let value = context.raw || 0;
                return `${label}: ${value} students`;
              }
            }
          }
        },
        responsive: true,
        maintainAspectRatio: false
      }
    });
  </script>
</body>
{% endblock %}