{% extends "base.html" %}
{% load static %}

{% block title %}{{ student_name }}'s Dashboard | TrinityEd{% endblock %}

{% block extra_head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #f0faff, #fdfdff, #eaf3ff);
      background-size: 300% 300%;
      animation: gradientShift 12s ease infinite;
      font-family: 'Inter', sans-serif;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .mac-window {
      width: 90%;
      margin: 2rem auto;
      height: 90vh;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 14px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    .mac-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #f5f5f7;
      border-bottom: 1px solid #ddd;
    }
    .mac-btn { width: 12px; height: 12px; border-radius: 50%; margin-right: 6px; cursor: pointer; }
    .mac-btn.red { background: #ff5f57; }
    .mac-btn.yellow { background: #ffbd2f; }
    .mac-btn.green { background: #28c840; }

    .notification-wrapper { position: relative; cursor: pointer; }
    .notification-icon { font-size: 28px; color: #555; transition: transform 0.2s ease; }
    .notification-wrapper:hover .notification-icon { transform: scale(1.2); color: #2563eb; }
    .notification-count { position: absolute; top: -4px; right: -6px; background: #ef4444; color: white;
      font-size: 12px; font-weight: bold; padding: 2px 6px; border-radius: 999px; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
    .notification-dropdown { position: absolute; top: 40px; right: 0; width: 300px; background: white;
      border-radius: 14px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); opacity: 0; transform: translateY(-20px);
      pointer-events: none; transition: all 0.3s ease; z-index: 50; }
    .notification-dropdown.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .notification-item { padding: 12px 16px; font-size: 14px; color: #333; border-bottom: 1px solid #eee; }
    .notification-item:last-child { border-bottom: none; }

    .stat-card { 
      background: rgba(255,255,255,0.9); 
      backdrop-filter: blur(14px); 
      border-radius: 20px; 
      padding: 20px;
      border: 1px solid rgba(37,99,235,0.1); 
      display: flex; 
      align-items: center; 
      gap: 20px;
      transition: transform 0.3s ease, box-shadow 0.3s ease; 
    }
    .stat-card:hover { transform: scale(1.05); box-shadow: 0 8px 28px rgba(37,99,235,0.25); }

    .chart-box { border-radius: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(16px);
      border: 1px solid rgba(37,99,235,0.15); padding: 20px; }
    .chart-box:hover { transform: scale(1.02); box-shadow: 0 12px 28px rgba(37,99,235,0.2); }

    .low-text { color: green; }
    .medium-text { color: orange; }
    .high-text { color: red; }

    /* Progress Ring */
    .progress-ring__circle {
      stroke-dasharray: 339.292;
      stroke-dashoffset: 339.292;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      stroke-linecap: round;
      filter: drop-shadow(0 0 3px currentColor);
      transition: stroke-dashoffset 1.5s ease, stroke 0.5s ease;
    }

    /* Custom Gradients for Student Stats */
    .gradient-gpa { stroke: url(#gradientBlue); }      
    .gradient-attendance { stroke: url(#gradientGreen); } 
    .gradient-credits { stroke: url(#gradientOrange); }   
    .gradient-incidents { stroke: url(#gradientRed); }    
  </style>
{% endblock %}

{% block content %}
<div id="macWindow" class="mac-window">
  <div class="mac-header">
    <div class="flex items-center">
      <span id="btnClose" class="mac-btn red"></span>
      <span id="btnMinimize" class="mac-btn yellow"></span>
      <span id="btnMaximize" class="mac-btn green"></span>
      <span class="ml-4 font-medium text-gray-600">Student Dashboard</span>
    </div>
    <div class="notification-wrapper" id="notifBtn">
      <span class="material-icons notification-icon">notifications</span>
      <span class="notification-count" id="notifCount">{{ notifications|length }}</span>
      <div class="notification-dropdown" id="notifDropdown">
        {% if notifications %}
          {% for notif in notifications %}
            <div class="notification-item">{{ notif }}</div>
          {% endfor %}
        {% else %}
          <div class="notification-item text-gray-500">No new notifications</div>
        {% endif %}
      </div>
    </div>
  </div>

  <main id="macContent" class="flex-1 p-8 overflow-y-auto">
    <!-- Student Profile -->
    <div class="flex items-start justify-between mb-10">
      <div class="flex items-center gap-6">
        <img src="{% static 'img/StudentDashboard.png' %}" alt="Profile"
             class="w-28 h-28 rounded-full object-cover shadow-md border">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">{{ student_name }}</h1>
          <p class="text-gray-600"><strong>ID:</strong> {{ student_id }}</p>
          <p class="text-gray-600"><strong>Grade:</strong> {{ grade }}</p>
          <p class="text-gray-600"><strong>Email:</strong> <a href="mailto:{{ email }}" class="text-blue-600 hover:underline">{{ email }}</a></p>
          <p class="text-gray-600"><strong>Phone:</strong> {{ phone }}</p>
        </div>
      </div>
      <div class="text-right">
        <p class="text-lg font-semibold text-red-600">Risk Level: High</p>
        <p class="text-sm text-green-600"><strong>Score:</strong> 7.1/10</p>
      </div>
    </div>

    <!-- Stats Row with Progress Rings -->
    <svg width="0" height="0">
      <defs>
        <linearGradient id="gradientBlue" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#2563eb"/>
          <stop offset="100%" stop-color="#60a5fa"/>
        </linearGradient>
        <linearGradient id="gradientGreen" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#16a34a"/>
          <stop offset="100%" stop-color="#4ade80"/>
        </linearGradient>
        <linearGradient id="gradientOrange" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#d97706"/>
          <stop offset="100%" stop-color="#fbbf24"/>
        </linearGradient>
        <linearGradient id="gradientRed" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#dc2626"/>
          <stop offset="100%" stop-color="#f87171"/>
        </linearGradient>
      </defs>
    </svg>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <!-- GPA -->
      <div class="stat-card">
        <div class="relative w-20 h-20 flex items-center justify-center">
          <svg class="w-20 h-20 absolute" viewBox="0 0 120 120">
            <circle stroke="#e5e7eb" stroke-width="10" fill="transparent" r="54" cx="60" cy="60"/>
            <circle class="progress-ring__circle gradient-gpa" stroke-width="10" fill="transparent" r="54" cx="60" cy="60" data-value="2.6" data-max="4"/>
          </svg>
          <span class="material-icons text-blue-600 text-3xl">school</span>
        </div>
        <div>
          <p class="text-sm text-gray-500">Current GPA</p>
          <p class="text-2xl font-bold">2.60</p>
          <p class="text-xs text-red-600">-0.42 from last term</p>
        </div>
      </div>

      <!-- Attendance -->
      <div class="stat-card">
        <div class="relative w-20 h-20 flex items-center justify-center">
          <svg class="w-20 h-20 absolute" viewBox="0 0 120 120">
            <circle stroke="#e5e7eb" stroke-width="10" fill="transparent" r="54" cx="60" cy="60"/>
            <circle class="progress-ring__circle gradient-attendance" stroke-width="10" fill="transparent" r="54" cx="60" cy="60" data-value="74.1" data-max="100"/>
          </svg>
          <span class="material-icons text-green-600 text-3xl">event_available</span>
        </div>
        <div>
          <p class="text-sm text-gray-500">Attendance Rate</p>
          <p class="text-2xl font-bold">74.1%</p>
          <p class="text-xs text-red-600">-4.5% from last month</p>
        </div>
      </div>

      <!-- Credits -->
      <div class="stat-card">
        <div class="relative w-20 h-20 flex items-center justify-center">
          <svg class="w-20 h-20 absolute" viewBox="0 0 120 120">
            <circle stroke="#e5e7eb" stroke-width="10" fill="transparent" r="54" cx="60" cy="60"/>
            <circle class="progress-ring__circle gradient-credits" stroke-width="10" fill="transparent" r="54" cx="60" cy="60" data-value="18" data-max="24"/>
          </svg>
          <span class="material-icons text-yellow-600 text-3xl">workspace_premium</span>
        </div>
        <div>
          <p class="text-sm text-gray-500">Credits Earned</p>
          <p class="text-2xl font-bold">18/24</p>
          <p class="text-xs text-green-600">+12 this term</p>
        </div>
      </div>

      <!-- Incidents -->
      <div class="stat-card">
        <div class="relative w-20 h-20 flex items-center justify-center">
          <svg class="w-20 h-20 absolute" viewBox="0 0 120 120">
            <circle stroke="#e5e7eb" stroke-width="10" fill="transparent" r="54" cx="60" cy="60"/>
            <circle class="progress-ring__circle gradient-incidents" stroke-width="10" fill="transparent" r="54" cx="60" cy="60" data-value="3" data-max="10"/>
          </svg>
          <span class="material-icons text-red-600 text-3xl">report_problem</span>
        </div>
        <div>
          <p class="text-sm text-gray-500">Behavioral Incidents</p>
          <p class="text-2xl font-bold">3</p>
          <p class="text-xs text-red-600">0 this month</p>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="chart-box"><h3 class="font-semibold mb-4">Weekly Attendance</h3><canvas id="attendanceChart"></canvas></div>
      <div class="chart-box"><h3 class="font-semibold mb-4">Test Scores</h3><canvas id="performanceChart"></canvas></div>
    </div>

    <!-- Messages -->
    <div class="mt-8 chart-box">
      <h3 class="font-semibold mb-4">Status & Messages</h3>
      <p class="text-lg">Dropout Risk: <span class="font-bold {{ dropout_risk|lower }}-text">{{ dropout_risk }}</span></p>
      <ul class="mt-4 divide-y divide-gray-200">
        {% for message in messages %}
          <li class="py-2">{{ message|safe }}</li>
        {% endfor %}
      </ul>
    </div>
  </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Mac controls
  const macWindow = document.getElementById("macWindow");
  const macContent = document.getElementById("macContent");
  const btnClose = document.getElementById("btnClose");
  const btnMinimize = document.getElementById("btnMinimize");
  const btnMaximize = document.getElementById("btnMaximize");
  let isMaximized = false, isMinimized = false;

  btnClose.onclick = () => macWindow.style.display = "none";
  btnMinimize.addEventListener("click",()=>{
    if(!isMinimized && !isMaximized){
      macContent.style.display="none";
      macWindow.style.position="static";
      macWindow.style.width="90%";
      macWindow.style.height="auto";
      macWindow.style.margin="2rem auto";
      macWindow.style.borderRadius="14px";
    } else if(isMinimized){
      macContent.style.display="block";
      macWindow.style.position="static";
      macWindow.style.width="90%";
      macWindow.style.height="90vh";
      macWindow.style.margin="2rem auto";
      macWindow.style.borderRadius="14px";
    }
    isMinimized=!isMinimized;
  });
  btnMaximize.onclick = () => {
    if (!isMaximized) { macWindow.style.position="fixed"; macWindow.style.top="0"; macWindow.style.left="0";
      macWindow.style.width="100%"; macWindow.style.height="100vh"; macWindow.style.margin="0"; macWindow.style.borderRadius="0"; }
    else { macWindow.style.position="static"; macWindow.style.width="90%"; macWindow.style.height="90vh"; macWindow.style.margin="2rem auto"; macWindow.style.borderRadius="14px"; }
    macContent.style.display="block"; isMaximized=!isMaximized; if (isMaximized) isMinimized=false;
  };

  // Notifications
  const notifBtn = document.getElementById("notifBtn");
  const notifDropdown = document.getElementById("notifDropdown");
  notifBtn.addEventListener("click", () => notifDropdown.classList.toggle("active"));
  window.addEventListener("click", (e) => { if (!notifBtn.contains(e.target)) notifDropdown.classList.remove("active"); });

  // Progress Ring Animation
  document.querySelectorAll(".progress-ring__circle").forEach(circle => {
    const radius = circle.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;
    circle.style.strokeDasharray = `${circumference}`;
    circle.style.strokeDashoffset = `${circumference}`;
    const value = parseFloat(circle.dataset.value);
    const max = parseFloat(circle.dataset.max);
    const percent = value / max;
    const offset = circumference - percent * circumference;
    setTimeout(() => {
      circle.style.strokeDashoffset = offset;
    }, 300);
  });

  // Attendance Chart
  new Chart(document.getElementById('attendanceChart'), {
    type: 'line',
    data: {
      labels: ['Sep 8', 'Sep 9', 'Sep 10', 'Sep 11', 'Sep 12', 'Sep 13', 'Sep 14'],
      datasets: [{
        label: 'Attendance %',
        data: [75, 73, 70, 72, 76, 74, 74],
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37,99,235,0.15)',
        fill: true,
        tension: 0.35,
        borderWidth: 3
      }]
    },
    options: { scales: { y: { max: 100, beginAtZero: true } } }
  });

  // Performance Chart
  new Chart(document.getElementById('performanceChart'), {
    type: 'bar',
    data: {
      labels: ['Test 1', 'Test 2', 'Test 3'],
      datasets: [{
        label: 'Scores',
        data: [68, 72, 70],
        borderRadius: 14,
        backgroundColor: ['#2563eb', '#dc2626', '#f59e0b']
      }]
    },
    options: { scales: { y: { max: 100, beginAtZero: true } } }
  });
</script>
{% endblock %}
