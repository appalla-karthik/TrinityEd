{% extends "base.html" %}
{% load static %}

{% block title %}{{ student_name }}'s Dashboard | TrinityEd{% endblock %}

{% block extra_head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #f0faff, #fdfdff, #eaf3ff);
      background-size: 300% 300%;
      animation: gradientShift 12s ease infinite;
      color: black !important; /* Override text-white from base */
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Stat cards */
    .stat-card {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(14px);
      border-radius: 20px;
      border: 1px solid rgba(37,99,235,0.1);
      transition: transform 0.4s ease, box-shadow 0.4s ease;
    }
    .stat-card:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 28px rgba(37,99,235,0.25);
    }

    /* Chart boxes */
    .chart-box {
      border-radius: 20px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(37,99,235,0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .chart-box:hover { 
      transform: scale(1.04); 
      box-shadow: 0 14px 32px rgba(37,99,235,0.28);
    }
  </style>
{% endblock %}

{% block content %}
  <main class="flex-1 p-8 overflow-y-auto animate-fadeIn">

    <!-- Greeting -->
    <h1 class="text-3xl font-bold text-gray-700 mb-8">ðŸ‘‹ Welcome, {{ student_name }}!</h1>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

      <!-- Attendance -->
      <div class="stat-card p-6 flex items-center gap-5">
        <span class="material-icons text-4xl text-blue-600">event_available</span>
        <div>
          <h3 class="text-sm font-medium text-gray-500">Attendance</h3>
          <p class="text-3xl font-extrabold text-blue-700">{{ attendance }}%</p>
        </div>
      </div>

      <!-- Average Score -->
      <div class="stat-card p-6 flex items-center gap-5">
        <span class="material-icons text-4xl text-yellow-500">school</span>
        <div>
          <h3 class="text-sm font-medium text-gray-500">Average Score</h3>
          <p class="text-3xl font-extrabold text-yellow-600">{{ avg_score }}%</p>
        </div>
      </div>

      <!-- Fee Status -->
      <div class="stat-card p-6 flex items-center gap-5">
        <span class="material-icons text-4xl text-green-600">payment</span>
        <div>
          <h3 class="text-sm font-medium text-gray-500">Fee Status</h3>
          <p class="text-3xl font-extrabold text-green-600">{{ fee_status }}</p>
        </div>
      </div>

    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="chart-box p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-700">Weekly Attendance</h3>
        <canvas id="attendanceChart"></canvas>
      </div>
      <div class="chart-box p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-700">Test Scores</h3>
        <canvas id="performanceChart"></canvas>
      </div>
    </div>

    <!-- Dropout Risk and Messages -->
    <div class="mt-8 chart-box p-6">
      <h3 class="text-lg font-semibold mb-4 text-gray-700">Status & Messages</h3>
      <div class="mb-4">
        <p class="text-lg font-medium text-gray-700">Dropout Risk: <span class="font-bold {{ dropout_risk|lower }}-text">{{ dropout_risk }}</span></p>
        <style>
          .low-text { color: green; }
          .medium-text { color: orange; }
          .high-text { color: red; }
        </style>
      </div>
      <ul class="divide-y divide-gray-200">
        {% for message in messages %}
          <li class="py-2">{{ message|safe }}</li>
        {% endfor %}
      </ul>
    </div>

  </main>
{% endblock %}

{% block extra_js %}
  <script>
    // Attendance Chart
    try {
      const attendanceChartCtx = document.getElementById('attendanceChart').getContext('2d');
      new Chart(attendanceChartCtx, {
        type: 'line',
        data: {
          labels: {{ attendance_weeks|safe }},
          datasets: [{
            label: 'Attendance %',
            data: {{ attendance_values|safe }},
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.15)',
            fill: true,
            tension: 0.35,
            borderWidth: 3,
            pointRadius: 6,
            pointHoverRadius: 8
          }]
        },
        options: {
          scales: {
            y: {
              max: 100,
              beginAtZero: true
            }
          }
        }
      });
    } catch (e) {
      console.error('Error rendering attendance chart:', e);
    }

    // Performance Chart
    try {
      const performanceChartCtx = document.getElementById('performanceChart').getContext('2d');
      new Chart(performanceChartCtx, {
        type: 'bar',
        data: {
          labels: {{ score_tests|safe }},
          datasets: [{
            label: 'Scores',
            data: {{ score_values|safe }},
            borderRadius: 14,
            backgroundColor: ['#2563eb', '#dc2626', '#f59e0b', '#16a34a'].slice(0, {{ score_tests|length|safe }})
          }]
        },
        options: {
          scales: {
            y: {
              max: 100,
              beginAtZero: true
            }
          }
        }
      });
    } catch (e) {
      console.error('Error rendering performance chart:', e);
    }
  </script>
{% endblock %}